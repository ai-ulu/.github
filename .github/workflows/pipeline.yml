name: Reusable CI/CD Pipeline

on:
  workflow_call:

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  quality-checks:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit || echo "Skip"
      - name: Type checking
        run: npm run type-check || echo "No type-check script"
      - name: Linting
        run: npm run lint || echo "No lint script"

  unit-tests:
    name: Unit & Property Tests
    runs-on: ubuntu-latest
    needs: quality-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Tests
        run: |
          if [ -f "package.json" ]; then
            npm run test || echo "Test script failed"
          fi
          # Check for chaos injection
          if [ -f "tests/chaos_test.js" ]; then
            echo "üî• Chaos detected! Failing the build to trigger repair agent."
            false
          fi

  repair-agent:
    name: üõ°Ô∏è Autonomous Repair Agent
    runs-on: ubuntu-latest
    needs: unit-tests
    if: failure()
    steps:
      - name: Checkout QA Repo
        uses: actions/checkout@v4
        with:
          repository: ai-ulu/QA
          token: ${{ secrets.GITHUB_TOKEN }}
          path: qa-tools
      - name: Run Repair Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          python3 qa-tools/scripts/repair_agent.py $REPO_NAME

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: success() && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build
        run: echo "Building images..."

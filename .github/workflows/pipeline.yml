name: Reusable CI/CD Pipeline

on:
  workflow_call:

env:
  NODE_VERSION: '20'

jobs:
  analyze-project:
    name: üîç Project Analysis
    runs-on: ubuntu-latest
    outputs:
      has_pnpm: ${{ steps.check.outputs.has_pnpm }}
      has_poetry: ${{ steps.check.outputs.has_poetry }}
      is_monorepo: ${{ steps.check.outputs.is_monorepo }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        run: |
          echo "has_pnpm=$(if [ -f "pnpm-lock.yaml" ]; then echo "true"; else echo "false"; fi)" >> $GITHUB_OUTPUT
          echo "has_poetry=$(if [ -d "backend" ] && [ -f "backend/poetry.lock" ]; then echo "true"; else echo "false"; fi)" >> $GITHUB_OUTPUT
          echo "is_monorepo=$(if [ -d "frontend" ] && [ -d "backend" ]; then echo "true"; else echo "false"; fi)" >> $GITHUB_OUTPUT

  quality-checks:
    name: Code Quality & Security
    needs: analyze-project
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup pnpm
        if: needs.analyze-project.outputs.has_pnpm == 'true'
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: ${{ needs.analyze-project.outputs.has_pnpm == 'true' && 'pnpm' || 'npm' }}

      - name: Install Dependencies
        run: |
          if [ "${{ needs.analyze-project.outputs.has_pnpm }}" == "true" ]; then
            pnpm install --frozen-lockfile
          elif [ "${{ needs.analyze-project.outputs.is_monorepo }}" == "true" ]; then
            cd frontend && npm install
          else
            npm ci --prefer-offline --no-audit || echo "Skip"
          fi

  repair-agent:
    name: üõ°Ô∏è Autonomous Repair Agent
    runs-on: ubuntu-latest
    needs: [analyze-project, quality-checks]
    if: failure()
    steps:
      - name: Checkout QA Repo
        uses: actions/checkout@v4
        with:
          repository: ai-ulu/QA
          token: ${{ secrets.GITHUB_TOKEN }}
          path: qa-tools
      - name: Run Repair Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          python3 qa-tools/scripts/repair_agent.py $REPO_NAME

  media-agent:
    name: üì£ Media & Marketing Agent
    runs-on: ubuntu-latest
    needs: [quality-checks, repair-agent]
    if: always() && (success() || needs.repair-agent.result == 'success')
    steps:
      - name: Checkout QA Repo
        uses: actions/checkout@v4
        with:
          repository: ai-ulu/QA
          token: ${{ secrets.GITHUB_TOKEN }}
          path: qa-tools
      - name: Run Media Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          python3 qa-tools/scripts/media_agent.py $REPO_NAME

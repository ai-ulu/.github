name: Reusable CI/CD Pipeline

on:
  workflow_call:

env:
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  quality-checks:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit || echo "Skip"

  unit-tests:
    name: Unit & Property Tests
    runs-on: ubuntu-latest
    needs: quality-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run Tests
        run: |
          # Check for chaos injection
          if [ -f "tests/chaos_test.js" ]; then
            echo "üî• Chaos detected! Failing the build to trigger repair agent."
            false
          fi

  repair-agent:
    name: üõ°Ô∏è Autonomous Repair Agent
    runs-on: ubuntu-latest
    needs: unit-tests
    if: failure()
    steps:
      - name: Checkout QA Repo
        uses: actions/checkout@v4
        with:
          repository: ai-ulu/QA
          token: ${{ secrets.GITHUB_TOKEN }}
          path: qa-tools
      - name: Run Repair Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          python3 qa-tools/scripts/repair_agent.py $REPO_NAME

  media-agent:
    name: üì£ Media & Marketing Agent
    runs-on: ubuntu-latest
    needs: [unit-tests, repair-agent]
    if: always() && (success() || needs.repair-agent.result == 'success')
    steps:
      - name: Checkout QA Repo
        uses: actions/checkout@v4
        with:
          repository: ai-ulu/QA
          token: ${{ secrets.GITHUB_TOKEN }}
          path: qa-tools
      - name: Run Media Agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_NAME=$(echo ${{ github.repository }} | cut -d'/' -f2)
          # Only run Media Agent on meaningful events (like after a repair or major push)
          if [[ "${{ needs.repair-agent.result }}" == "success" ]]; then
            echo "Healing event detected. Launching Media Agent..."
            python3 qa-tools/scripts/media_agent.py $REPO_NAME
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "Push event detected. Logging update..."
            python3 qa-tools/scripts/media_agent.py $REPO_NAME
          fi

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: success() && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build
        run: echo "Building images..."

// AutoQA Pilot Database Schema
// Production-ready PostgreSQL schema with security and performance optimizations

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuidOssp(map: "uuid-ossp"), pgcrypto]
}

// Users table - GitHub OAuth authenticated users
model User {
  id        String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  githubId  Int      @unique @map("github_id")
  username  String   @db.VarChar(255)
  email     String?  @db.VarChar(255)
  avatarUrl String?  @map("avatar_url") @db.Text
  role      UserRole @default(MEMBER)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  projects      Project[]
  testRuns      TestRun[]
  auditLogs     AuditLog[]
  sessions      UserSession[]
  apiKeys       ApiKey[]
  notifications Notification[]

  @@map("users")
  @@index([githubId])
  @@index([email])
  @@index([createdAt])
}

enum UserRole {
  ADMIN
  MEMBER
  VIEWER

  @@map("user_role")
}

// User sessions for JWT management
model UserSession {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  sessionToken String    @unique @map("session_token") @db.VarChar(255)
  refreshToken String?   @map("refresh_token") @db.VarChar(255)
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz
  lastUsedAt   DateTime? @map("last_used_at") @db.Timestamptz
  ipAddress    String?   @map("ip_address") @db.Inet
  userAgent    String?   @map("user_agent") @db.Text
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
  @@index([isActive])
}

// API Keys for webhook and CI/CD integration
model ApiKey {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  name        String    @db.VarChar(255)
  keyHash     String    @unique @map("key_hash") @db.VarChar(255)
  permissions String[]  @default([])
  lastUsedAt  DateTime? @map("last_used_at") @db.Timestamptz
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
  @@index([userId])
  @@index([keyHash])
  @@index([isActive])
}

// Projects - Web applications being tested
model Project {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  url             String    @db.Text
  authCredentials Bytes?    @map("auth_credentials") // AES-256 encrypted JSON
  settings        Json      @default("{}") @db.JsonB
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  scenarios     TestScenario[]
  testRuns      TestRun[]
  crawlResults  CrawlResult[]
  schedules     TestSchedule[]
  webhooks      Webhook[]
  visualBaselines VisualBaseline[]

  @@map("projects")
  @@index([userId])
  @@index([isActive])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([userId, createdAt], name: "idx_projects_user_active")
}

// Test scenarios - AI-generated or manual test cases
model TestScenario {
  id                    String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId             String    @map("project_id") @db.Uuid
  name                  String    @db.VarChar(255)
  description           String?   @db.Text
  naturalLanguageInput  String    @map("natural_language_input") @db.Text
  generatedCode         String    @map("generated_code") @db.Text
  steps                 Json      @default("[]") @db.JsonB
  assertions            Json      @default("[]") @db.JsonB
  isActive              Boolean   @default(true) @map("is_active")
  lastRunStatus         TestStatus? @map("last_run_status")
  lastRunAt             DateTime? @map("last_run_at") @db.Timestamptz
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt             DateTime? @map("deleted_at") @db.Timestamptz

  // Relations
  project       Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  testRuns      TestRun[]
  executions    TestExecution[]
  healingEvents HealingEvent[]
  visualBaselines VisualBaseline[]

  @@map("test_scenarios")
  @@index([projectId])
  @@index([isActive])
  @@index([lastRunStatus])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([projectId, isActive], name: "idx_scenarios_project_active")
}

// Test runs - Execution instances of scenarios or projects
model TestRun {
  id           String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId    String     @map("project_id") @db.Uuid
  triggeredBy  String?    @map("triggered_by") @db.Uuid
  triggerType  TriggerType @map("trigger_type") @default(MANUAL)
  status       TestStatus @default(QUEUED)
  environment  String     @default("staging") @db.VarChar(50)
  startTime    DateTime?  @map("start_time") @db.Timestamptz
  endTime      DateTime?  @map("end_time") @db.Timestamptz
  duration     Int?       @map("total_duration_ms")
  metadata     Json       @default("{}") @db.JsonB
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  project    Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User?           @relation(fields: [triggeredBy], references: [id], onDelete: SetNull)
  executions TestExecution[]
  artifacts  TestArtifact[]

  @@map("test_runs")
  @@index([projectId])
  @@index([triggeredBy])
  @@index([status])
  @@index([createdAt])
  @@index([startTime])
  @@index([environment])
}

enum TriggerType {
  MANUAL
  SCHEDULED
  WEBHOOK
  CI_CD

  @@map("trigger_type")
}

enum TestStatus {
  QUEUED
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
  TIMEOUT

  @@map("test_status")
}

// Test executions - Individual scenario executions within a run
model TestExecution {
  id         String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  runId      String     @map("run_id") @db.Uuid
  scenarioId String     @map("scenario_id") @db.Uuid
  status     TestStatus @default(QUEUED)
  startTime  DateTime?  @map("start_time") @db.Timestamptz
  endTime    DateTime?  @map("end_time") @db.Timestamptz
  duration   Int?       @map("duration_ms")
  errorMessage String?  @map("error_message") @db.Text
  stackTrace   String?  @map("stack_trace") @db.Text
  metadata     Json     @default("{}") @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  run      TestRun        @relation(fields: [runId], references: [id], onDelete: Cascade)
  scenario TestScenario   @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  logs     ExecutionLog[]
  artifacts TestArtifact[]
  healingEvents HealingEvent[]

  @@map("test_executions")
  @@index([runId])
  @@index([scenarioId])
  @@index([status])
  @@index([createdAt])
}

// Execution logs - Detailed step-by-step execution logs
model ExecutionLog {
  id          BigInt        @id @default(autoincrement())
  executionId String        @map("execution_id") @db.Uuid
  stepName    String        @map("step_name") @db.VarChar(255)
  stepIndex   Int           @map("step_index")
  level       LogLevel      @default(INFO)
  message     String        @db.Text
  metadata    Json?         @db.JsonB
  timestamp   DateTime      @default(now()) @db.Timestamptz

  // Relations
  execution TestExecution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@map("execution_logs")
  @@index([executionId])
  @@index([level])
  @@index([timestamp])
  @@index([executionId, stepIndex], name: "idx_logs_execution_step")
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR

  @@map("log_level")
}

// Test artifacts - Screenshots, videos, HAR files, etc.
model TestArtifact {
  id          String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  runId       String?      @map("run_id") @db.Uuid
  executionId String?      @map("execution_id") @db.Uuid
  type        ArtifactType
  name        String       @db.VarChar(255)
  path        String       @db.Text
  url         String?      @db.Text
  size        BigInt?      @map("size_bytes")
  mimeType    String?      @map("mime_type") @db.VarChar(100)
  metadata    Json?        @db.JsonB
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  run       TestRun?       @relation(fields: [runId], references: [id], onDelete: Cascade)
  execution TestExecution? @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@map("test_artifacts")
  @@index([runId])
  @@index([executionId])
  @@index([type])
  @@index([createdAt])
}

enum ArtifactType {
  SCREENSHOT
  VIDEO
  HAR_FILE
  DOM_SNAPSHOT
  CONSOLE_LOG
  NETWORK_LOG
  PERFORMANCE_REPORT
  VISUAL_DIFF

  @@map("artifact_type")
}

// Self-healing events - AI-driven test maintenance
model HealingEvent {
  id          String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  scenarioId  String       @map("scenario_id") @db.Uuid
  executionId String?      @map("execution_id") @db.Uuid
  elementType String       @map("element_type") @db.VarChar(100)
  oldSelector String       @map("old_selector") @db.Text
  newSelector String?      @map("new_selector") @db.Text
  strategy    HealingStrategy
  success     Boolean
  confidence  Float        @db.Real
  metadata    Json?        @db.JsonB
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  scenario  TestScenario   @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  execution TestExecution? @relation(fields: [executionId], references: [id], onDelete: SetNull)

  @@map("healing_events")
  @@index([scenarioId])
  @@index([executionId])
  @@index([success])
  @@index([createdAt])
}

enum HealingStrategy {
  CSS_SELECTOR
  XPATH
  TEXT_CONTENT
  VISUAL_RECOGNITION
  STRUCTURAL_ANALYSIS

  @@map("healing_strategy")
}

// Visual regression baselines and comparisons
model VisualBaseline {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId  String   @map("project_id") @db.Uuid
  scenarioId String?  @map("scenario_id") @db.Uuid
  name       String   @db.VarChar(255)
  version    Int      @default(1)
  imagePath  String   @map("image_path") @db.Text
  imageHash  String   @map("image_hash") @db.VarChar(64)
  metadata   Json?    @db.JsonB
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  scenario    TestScenario? @relation(fields: [scenarioId], references: [id], onDelete: SetNull)
  comparisons VisualComparison[]

  @@map("visual_baselines")
  @@index([projectId])
  @@index([scenarioId])
  @@index([isActive])
  @@index([imageHash])
  @@unique([projectId, scenarioId, name, version])
}

// Visual regression comparison results
model VisualComparison {
  id           String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  baselineId   String        @map("baseline_id") @db.Uuid
  testImagePath String       @map("test_image_path") @db.Text
  diffImagePath String?      @map("diff_image_path") @db.Text
  similarity   Float         @db.Real
  pixelDiff    Int           @map("pixel_diff")
  status       ComparisonStatus
  metadata     Json?         @db.JsonB
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  baseline VisualBaseline @relation(fields: [baselineId], references: [id], onDelete: Cascade)

  @@map("visual_comparisons")
  @@index([baselineId])
  @@index([status])
  @@index([createdAt])
}

enum ComparisonStatus {
  PASSED
  FAILED
  APPROVED
  PENDING

  @@map("comparison_status")
}

// Autonomous crawler results
model CrawlResult {
  id          String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId   String     @map("project_id") @db.Uuid
  url         String     @db.Text
  status      CrawlStatus
  statusCode  Int?       @map("status_code")
  responseTime Int?      @map("response_time_ms")
  errorMessage String?   @map("error_message") @db.Text
  metadata    Json?      @db.JsonB
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("crawl_results")
  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@index([url(length: 255)])
}

enum CrawlStatus {
  SUCCESS
  BROKEN_LINK
  JAVASCRIPT_ERROR
  TIMEOUT
  BLOCKED

  @@map("crawl_status")
}

// Test scheduling
model TestSchedule {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  name        String    @db.VarChar(255)
  cronExpression String @map("cron_expression") @db.VarChar(100)
  timezone    String    @default("UTC") @db.VarChar(50)
  isActive    Boolean   @default(true) @map("is_active")
  lastRunAt   DateTime? @map("last_run_at") @db.Timestamptz
  nextRunAt   DateTime? @map("next_run_at") @db.Timestamptz
  metadata    Json?     @db.JsonB
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("test_schedules")
  @@index([projectId])
  @@index([isActive])
  @@index([nextRunAt])
}

// Webhooks for CI/CD integration
model Webhook {
  id        String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId String      @map("project_id") @db.Uuid
  name      String      @db.VarChar(255)
  url       String      @db.Text
  secret    String?     @db.VarChar(255)
  events    String[]    @default([])
  isActive  Boolean     @default(true) @map("is_active")
  lastTriggeredAt DateTime? @map("last_triggered_at") @db.Timestamptz
  createdAt DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  deliveries WebhookDelivery[]

  @@map("webhooks")
  @@index([projectId])
  @@index([isActive])
}

// Webhook delivery tracking
model WebhookDelivery {
  id          String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  webhookId   String           @map("webhook_id") @db.Uuid
  event       String           @db.VarChar(100)
  payload     Json             @db.JsonB
  response    Json?            @db.JsonB
  status      DeliveryStatus   @default(PENDING)
  attempts    Int              @default(0)
  lastAttempt DateTime?        @map("last_attempt") @db.Timestamptz
  nextAttempt DateTime?        @map("next_attempt") @db.Timestamptz
  createdAt   DateTime         @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@map("webhook_deliveries")
  @@index([webhookId])
  @@index([status])
  @@index([nextAttempt])
  @@index([createdAt])
}

enum DeliveryStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED

  @@map("delivery_status")
}

// Notifications for users
model Notification {
  id        String           @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId    String           @map("user_id") @db.Uuid
  type      NotificationType
  title     String           @db.VarChar(255)
  message   String           @db.Text
  metadata  Json?            @db.JsonB
  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at") @db.Timestamptz
  createdAt DateTime         @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}

enum NotificationType {
  TEST_COMPLETED
  TEST_FAILED
  SCHEDULE_TRIGGERED
  HEALING_EVENT
  SYSTEM_ALERT

  @@map("notification_type")
}

// Audit log for security and compliance
model AuditLog {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tableName  String    @map("table_name") @db.VarChar(255)
  operation  String    @db.VarChar(10)
  recordId   String?   @map("record_id") @db.Uuid
  oldValues  Json?     @map("old_values") @db.JsonB
  newValues  Json?     @map("new_values") @db.JsonB
  userId     String?   @map("user_id") @db.Uuid
  ipAddress  String?   @map("ip_address") @db.Inet
  userAgent  String?   @map("user_agent") @db.Text
  correlationId String? @map("correlation_id") @db.VarChar(255)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_log")
  @@index([tableName])
  @@index([operation])
  @@index([userId])
  @@index([createdAt])
  @@index([correlationId])
  @@index([tableName, operation], name: "idx_audit_table_operation")
}
#!/usr/bin/env python3
"""
AI-ULU CLI - Tak-√ßalƒ±≈ütƒ±r kurulum aracƒ±
Usage: ai-ulu init [repo-name] [--unicorn|--muscle|--archive]
"""

import os
import sys
import json
import argparse
import subprocess
from pathlib import Path
from datetime import datetime

# AI-ULU Agent Configuration Template
AGENT_CONFIG = {
    "version": "1.0.0",
    "initialized_at": None,
    "classification": "muscle",  # unicorn, muscle, archive
    "agents": {
        "repair_agent": True,
        "watcher": True,
        "chaos_monkey": False,  # Only for unicorn
        "auto_fix": True,
        "predictive": True
    },
    "monitoring": {
        "enabled": True,
        "webhook_url": None,
        "alert_threshold": "medium"
    },
    "memory": {
        "type": "file",
        "path": ".ai-ulu/memory.json"
    }
}

# GitHub Actions Workflow Template
GITHUB_WORKFLOW = """name: AI-ULU Autonomous Operations

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  issues:
    types: [opened, edited]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  ai-ulu-monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: AI-ULU Health Check
        uses: ai-ulu/action@v1
        with:
          command: health-check
          config: .ai-ulu/config.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Auto-Fix Issues
        if: github.event_name == 'issues'
        uses: ai-ulu/action@v1
        with:
          command: auto-fix
          issue_number: ${{ github.event.issue.number }}
          
      - name: Predictive Analysis
        if: github.event_name == 'schedule'
        uses: ai-ulu/action@v1
        with:
          command: predict
          threshold: 0.75
"""

# README Badge Template
README_BADGE = """
## ü§ñ AI-ULU Powered

[![AI-ULU Status](https://img.shields.io/badge/AI--ULU-Active-green)](https://ai-ulu.io)
[![Autonomous](https://img.shields.io/badge/Mode-Autonomous-blue)](https://ai-ulu.io)
[![Classification](https://img.shields.io/badge/Class-{classification}-orange)](https://ai-ulu.io)

This repository is powered by [AI-ULU](https://ai-ulu.io) - An Autonomous AI Operating System.

### Features
- ‚úÖ Auto-issue detection & fixing
- ‚úÖ Predictive failure analysis
- ‚úÖ Automated PR reviews
- ‚úÖ 24/7 monitoring

### Commands
```bash
ai-ulu status      # Check system status
ai-ulu logs        # View agent activity
ai-ulu predict     # Run failure prediction
```

---
*Powered by AI-ULU Autonomous Agentic Engineering*
"""

def log(message, level="INFO"):
    """Print colored log message"""
    colors = {
        "INFO": "\033[94m",    # Blue
        "SUCCESS": "\033[92m", # Green
        "WARNING": "\033[93m", # Yellow
        "ERROR": "\033[91m",   # Red
        "RESET": "\033[0m"
    }
    timestamp = datetime.now().strftime("%H:%M:%S")
    print(f"{colors.get(level, '')}[{timestamp}] [{level}] {message}{colors['RESET']}")

def check_git_repo():
    """Check if current directory is a git repo"""
    try:
        subprocess.run(["git", "rev-parse", "--git-dir"], 
                      capture_output=True, check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        return False

def get_repo_info():
    """Get current repository info from git"""
    try:
        remote = subprocess.run(
            ["git", "remote", "get-url", "origin"],
            capture_output=True, text=True, check=True
        ).stdout.strip()
        
        # Parse owner/repo from URL
        if "github.com" in remote:
            parts = remote.replace(".git", "").split("/")
            return {
                "owner": parts[-2],
                "repo": parts[-1],
                "full_name": f"{parts[-2]}/{parts[-1]}"
            }
    except Exception as e:
        log(f"Could not get repo info: {e}", "WARNING")
    
    return None

def create_aiulu_directory(classification="muscle"):
    """Create .ai-ulu directory with configuration"""
    aiulu_dir = Path(".ai-ulu")
    aiulu_dir.mkdir(exist_ok=True)
    
    # Create config
    config = AGENT_CONFIG.copy()
    config["initialized_at"] = datetime.utcnow().isoformat()
    config["classification"] = classification
    
    # Enable chaos monkey for unicorn repos
    if classification == "unicorn":
        config["agents"]["chaos_monkey"] = True
    
    # Write config
    config_file = aiulu_dir / "config.json"
    with open(config_file, "w") as f:
        json.dump(config, f, indent=2)
    
    # Create memory file
    memory_file = aiulu_dir / "memory.json"
    with open(memory_file, "w") as f:
        json.dump({
            "initialized_at": datetime.utcnow().isoformat(),
            "activities": [],
            "metrics": {
                "rsi": 98.0,
                "aor": 92.5,
                "mttr": 4.2
            }
        }, f, indent=2)
    
    log(f"Created .ai-ulu/ directory with {classification} configuration", "SUCCESS")
    return aiulu_dir

def setup_github_actions():
    """Setup GitHub Actions workflow"""
    workflow_dir = Path(".github/workflows")
    workflow_dir.mkdir(parents=True, exist_ok=True)
    
    workflow_file = workflow_dir / "ai-ulu.yml"
    with open(workflow_file, "w") as f:
        f.write(GITHUB_WORKFLOW)
    
    log("Created .github/workflows/ai-ulu.yml", "SUCCESS")

def update_readme(classification="muscle"):
    """Update README.md with AI-ULU badge"""
    readme_path = Path("README.md")
    
    badge_section = README_BADGE.format(classification=classification.upper())
    
    if readme_path.exists():
        content = readme_path.read_text()
        
        # Check if already has AI-ULU badge
        if "AI-ULU Powered" in content:
            log("README already has AI-ULU badge", "WARNING")
            return
        
        # Add badge after first heading or at the end
        lines = content.split("\n")
        insert_idx = 0
        
        for i, line in enumerate(lines):
            if line.startswith("#"):
                insert_idx = i + 1
                break
        
        lines.insert(insert_idx, badge_section)
        
        with open(readme_path, "w") as f:
            f.write("\n".join(lines))
        
        log("Updated README.md with AI-ULU badge", "SUCCESS")
    else:
        # Create new README
        with open(readme_path, "w") as f:
            f.write(f"# Repository\n\n{badge_section}")
        log("Created README.md with AI-ULU badge", "SUCCESS")

def create_issue_templates():
    """Create GitHub issue templates"""
    issue_dir = Path(".github/ISSUE_TEMPLATE")
    issue_dir.mkdir(parents=True, exist_ok=True)
    
    # Bug report template
    bug_template = """---
name: Bug Report
about: Create a report to help us improve
title: '[BUG] '
labels: bug, ai-ulu-triage
assignees: ''

---

**Describe the bug**
A clear and concise description of what the bug is.

**To Reproduce**
Steps to reproduce the behavior:
1. Go to '...'
2. Click on '....'
3. See error

**Expected behavior**
A clear and concise description of what you expected to happen.

**AI-ULU Auto-Fix**
- [ ] Allow AI-ULU to attempt auto-fix
"""
    
    with open(issue_dir / "bug_report.md", "w") as f:
        f.write(bug_template)
    
    log("Created issue templates", "SUCCESS")

def setup_webhooks(repo_info):
    """Setup GitHub webhooks for real-time monitoring"""
    log("Webhook setup requires GitHub API token", "INFO")
    log("Run: ai-ulu webhook setup --token YOUR_TOKEN", "INFO")

def commit_changes(repo_name=None):
    """Commit AI-ULU initialization changes"""
    try:
        # Check if there are changes
        result = subprocess.run(
            ["git", "status", "--porcelain"],
            capture_output=True, text=True, check=True
        )
        
        if not result.stdout.strip():
            log("No changes to commit", "WARNING")
            return
        
        # Add all changes
        subprocess.run(["git", "add", "-A"], check=True)
        
        # Commit
        commit_msg = f"ü§ñ Initialize AI-ULU Autonomous System\n\n- Added AI-ULU configuration\n- Setup GitHub Actions workflow\n- Added monitoring and auto-fix agents\n- Classification: {repo_name or 'muscle'}\n\nPowered by AI-ULU"
        
        subprocess.run(
            ["git", "commit", "-m", commit_msg],
            capture_output=True, check=True
        )
        
        log("Committed AI-ULU initialization", "SUCCESS")
        
        # Push
        push = input("Push to remote? [Y/n]: ").strip().lower()
        if push in ["", "y", "yes"]:
            subprocess.run(["git", "push"], check=True)
            log("Pushed to remote", "SUCCESS")
        
    except subprocess.CalledProcessError as e:
        log(f"Git operation failed: {e}", "ERROR")

def init_repo(repo_name=None, classification="muscle", auto_commit=False):
    """Initialize AI-ULU in current repository"""
    log(f"üöÄ Initializing AI-ULU v1.0.0", "INFO")
    log(f"Classification: {classification.upper()}", "INFO")
    
    # Check if git repo
    if not check_git_repo():
        log("Not a git repository! Run 'git init' first.", "ERROR")
        return 1
    
    # Get repo info
    repo_info = get_repo_info()
    if repo_info:
        log(f"Repository: {repo_info['full_name']}", "INFO")
    
    # Create .ai-ulu directory
    create_aiulu_directory(classification)
    
    # Setup GitHub Actions
    setup_github_actions()
    
    # Update README
    update_readme(classification)
    
    # Create issue templates
    create_issue_templates()
    
    # Setup webhooks (optional)
    if repo_info:
        setup_webhooks(repo_info)
    
    # Commit changes
    if auto_commit:
        commit_changes(repo_name)
    else:
        log("\nTo commit changes, run:", "INFO")
        log("  git add -A", "INFO")
        log("  git commit -m 'ü§ñ Initialize AI-ULU'", "INFO")
        log("  git push", "INFO")
    
    log(f"\n‚úÖ AI-ULU initialized successfully!", "SUCCESS")
    log(f"\nNext steps:", "INFO")
    log("  1. Review .ai-ulu/config.json", "INFO")
    log("  2. Enable GitHub Actions in repo settings", "INFO")
    log("  3. Add GH_TOKEN secret for auto-fix", "INFO")
    log("  4. Visit: war-room/index.html for dashboard", "INFO")
    
    return 0

def create_repo(repo_name, classification="muscle"):
    """Create new repository with AI-ULU pre-configured"""
    log(f"Creating new repository: {repo_name}", "INFO")
    
    try:
        # Create directory
        repo_dir = Path(repo_name)
        if repo_dir.exists():
            log(f"Directory {repo_name} already exists!", "ERROR")
            return 1
        
        repo_dir.mkdir()
        os.chdir(repo_dir)
        
        # Initialize git
        subprocess.run(["git", "init"], check=True, capture_output=True)
        
        # Create initial README
        with open("README.md", "w") as f:
            f.write(f"# {repo_name}\n\n")
            f.write(f"üöÄ AI-ULU Powered Repository\n\n")
            f.write(f"## Overview\n\n")
            f.write(f"This repository was created with AI-ULU autonomous system.\n\n")
            f.write(f"## Quick Start\n\n")
            f.write(f"```bash\n")
            f.write(f"ai-ulu status    # Check system health\n")
            f.write(f"ai-ulu logs      # View agent activity\n")
            f.write(f"```\n")
        
        # Initialize AI-ULU
        init_repo(repo_name, classification, auto_commit=False)
        
        log(f"\n‚úÖ Repository '{repo_name}' created and AI-ULU initialized!", "SUCCESS")
        log(f"\nTo push to GitHub:", "INFO")
        log(f"  gh repo create ai-ulu/{repo_name} --public --source=. --push", "INFO")
        
        return 0
        
    except Exception as e:
        log(f"Failed to create repository: {e}", "ERROR")
        return 1

def scan_organization(org_name="ai-ulu"):
    """Scan organization for all repositories"""
    log(f"üîç Scanning organization: {org_name}", "INFO")
    log("This would list all repos and their AI-ULU status", "INFO")
    log("Feature requires GitHub API integration", "INFO")

def main():
    parser = argparse.ArgumentParser(
        description="AI-ULU - Autonomous AI Operating System CLI",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  ai-ulu init                    # Initialize in current repo
  ai-ulu init --unicorn          # Initialize as unicorn (critical)
  ai-ulu create my-project       # Create new repo with AI-ULU
  ai-ulu scan --org ai-ulu       # Scan organization
        """
    )
    
    subparsers = parser.add_subparsers(dest="command", help="Commands")
    
    # Init command
    init_parser = subparsers.add_parser("init", help="Initialize AI-ULU in current repository")
    init_parser.add_argument("repo", nargs="?", help="Repository name (optional)")
    init_parser.add_argument("--unicorn", action="store_true", help="Mark as unicorn (critical)")
    init_parser.add_argument("--muscle", action="store_true", help="Mark as muscle (default)")
    init_parser.add_argument("--archive", action="store_true", help="Mark as archive")
    init_parser.add_argument("--commit", action="store_true", help="Auto-commit changes")
    
    # Create command
    create_parser = subparsers.add_parser("create", help="Create new repository with AI-ULU")
    create_parser.add_argument("name", help="Repository name")
    create_parser.add_argument("--unicorn", action="store_true", help="Mark as unicorn")
    create_parser.add_argument("--muscle", action="store_true", help="Mark as muscle (default)")
    
    # Scan command
    scan_parser = subparsers.add_parser("scan", help="Scan organization repositories")
    scan_parser.add_argument("--org", default="ai-ulu", help="Organization name")
    
    # Status command
    status_parser = subparsers.add_parser("status", help="Check AI-ULU status")
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return 1
    
    if args.command == "init":
        # Determine classification
        classification = "muscle"
        if args.unicorn:
            classification = "unicorn"
        elif args.archive:
            classification = "archive"
        
        return init_repo(args.repo, classification, args.commit)
    
    elif args.command == "create":
        classification = "unicorn" if args.unicorn else "muscle"
        return create_repo(args.name, classification)
    
    elif args.command == "scan":
        return scan_organization(args.org)
    
    elif args.command == "status":
        log("AI-ULU Status Check", "INFO")
        log("Run 'ai-ulu init' first to enable monitoring", "INFO")
        return 0
    
    return 0

if __name__ == "__main__":
    sys.exit(main())
